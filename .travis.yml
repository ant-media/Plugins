dist: jammy
language: java
jdk:
- openjdk17
git:
  depth: false
addons:
  sonarcloud:
    organization: ant-media-plugins
    token: "$SONAR_TOKEN"
before_install:
- openssl aes-256-cbc -K $encrypted_171b1c559d7b_key -iv $encrypted_171b1c559d7b_iv
  -in signingkey.asc.enc -out signingkey.asc -d
- export GPG_TTY=$(tty) #-> https://github.com/keybase/keybase-issues/issues/2798
- gpg --batch --fast-import signingkey.asc
- sudo apt-get update -qq
- sudo apt-get install ffmpeg -qq -y
- (if [ $(git ls-remote https://github.com/ant-media/ant-media-server-parent.git $TRAVIS_BRANCH  |
  wc -l) == "1" ]; then echo " $TRAVIS_BRANCH branch found"; git clone --depth=1 -b
  $TRAVIS_BRANCH https://github.com/ant-media/ant-media-server-parent.git; else echo
  "$TRAVIS_BRANCH branch not found. Checking out master"; git clone --depth=1 https://github.com/ant-media/ant-media-server-parent.git;
  fi)
- cd ant-media-server-parent
- mvn clean install -DskipTests -Dmaven.javadoc.skip=true -Dgpg.skip=true --quiet
- cd ..
- (if [ $(git ls-remote https://github.com/ant-media/Ant-Media-Server.git $TRAVIS_BRANCH  |
  wc -l) == "1" ]; then echo "$TRAVIS_BRANCH branch found in Ant-Media-Server"; git
  clone --depth=1 -b $TRAVIS_BRANCH https://github.com/ant-media/Ant-Media-Server.git;
  else echo "$TRAVIS_BRANCH branch not found. Checking out master"; git clone --depth=1
  https://github.com/ant-media/Ant-Media-Server.git; fi)
- cd Ant-Media-Server
- mvn clean install -DskipTests -Dmaven.javadoc.skip=true -Dgpg.skip=true --quiet
- cd ..
script:

- cd MediaPushPlugin
- rm  src/main/resources/*
- cd src/main/js
- npm install
- npm run build
- cd ../../..
- mvn clean deploy -DskipTests=false --settings ../mvn-settings.xml

- cd ../FilterPlugin
- mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent deploy org.jacoco:jacoco-maven-plugin:report
  sonar:sonar -Dmaven.javadoc.skip=true -Dsonar.projectKey=ant-media_plugins --settings ../mvn-settings.xml --quiet

- cd ../SamplePlugin
- mvn clean install -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -Dgpg.skip=true

- cd ../TensorflowPlugin
- mvn clean install -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -Dgpg.skip=true

after_script:
- ls
- export FILE=hs_err_pid*.log
- (if  test -f $FILE ; then echo "$FILE exists."; cat $FILE; else echo "$FILE not
  exists."; fi)
